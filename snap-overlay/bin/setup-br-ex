#!/bin/bash
#
# Oneshot daemon which creates a networking bridge.
#
# Creates br-ex, and sets up an ip address for it. We put this in a
# oneshot so that the ip address persists after reboot, without
# needing to add networking entries to the host system. (We want this
# to work well when we turn off classic confinement.)

set -ex

extgateway=$(snapctl get extgateway)

# Create external integration bridge
ovs-vsctl --retry --may-exist add-br br-ex

# Configure br-ex
ip address add $extgateway/24 dev br-ex || :
ip link set br-ex up || :

sudo iptables -t nat -A POSTROUTING -s $extgateway/24 ! -d $extgateway/24 -j MASQUERADE

exit 0
